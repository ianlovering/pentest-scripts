#!/usr/bin/python

import os, os.path, sys
import glob
import fnmatch
from xml.etree import ElementTree
import argparse

parser = argparse.ArgumentParser()
parser.add_argument("root_dir", help="Root directory to start search for nessus files")
parser.add_argument("search_name", help="Search term for scan names")
args = parser.parse_args()

xml_element_tree = None
report = None

root_folder = args.root_dir
search_name = args.search_name

combined_scan_name = search_name + " (All)"
output_file = combined_scan_name + ".nessus"

print("Combining Nessus reports...")

for root, dirnames, filenames in os.walk(root_folder):
    for filename in fnmatch.filter(filenames, '*.nessus'):
        xml_file = os.path.join(root, filename)
        # get root
        data = ElementTree.parse(xml_file).getroot()

        # print ElementTree.tostring(data)
        for result in data.iter('Report'):
            if search_name in result.attrib['name']:
                if xml_element_tree is None:
                    xml_element_tree = data 
                    report = result
                else:
                    report.extend(result) 

if xml_element_tree is not None:
    print("Writing file...")
    fp = open(output_file, 'w')
    fp.write(ElementTree.tostring(xml_element_tree))
    fp.close()
    print("Written %s") % (output_file,)
    print("")
else:
    print("No data.")

