#!/bin/bash

root=$1
targets=$2
session=scan

unset TMUX
tmux has-session -t $session || tmux new-session -d -s $session
mkdir -p $root

for t in $(cat ${targets}); do
	while [[ $(tmux list-windows -t $session | wc -l) -gt 30 ]]; do
		sleep 10
	done

	mkdir ${root}/${t}
	tmux new-window -t ${session}: -n "TCP ${t}" "./scan-tcp.py ${root}/${t} ${t}"
	pushd ${root}/${t}
	#tmux new-window -t ${session}: -n "TCP ${t}" "nmap -vv --reason -sS -A -p- -oA ${t}.tcp.all ${t}"
	tmux new-window -t ${session}: -n "UDP ${t}" "nmap -vv --reason --max-retries=2 -sU -A -oA ${t}.udp.dflt ${t}"
	popd
done

